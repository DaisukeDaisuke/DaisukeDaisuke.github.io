<!DOCTYPE html>
<html lang="ja" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>乱数総当たりツール</title>
    <script src="rand.js"></script>
    <script src="main.js"></script>
    <style>
        .container {
            text-align: center;
            margin: 20px auto;
            max-width: 450px;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
        }

        select {
            width: 100%;
            padding: 15px; /* 高さを増やす */
            margin-bottom: 20px;
        }

        .blue-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .red-button {
            background-color: #F06060; /* 赤色の背景色 */
            color: white; /* テキストの色 */
            padding: 10px 20px; /* パディング */
            border: none; /* ボーダーなし */
            border-radius: 5px; /* 角丸 */
            cursor: pointer; /* ホバー時のカーソルスタイル */
        }

        body {
            margin-bottom: 800px; /* フッター部分の下側に20pxの余白を追加 */
        }

        .dropdown-container {
            position: relative;
        }

        .box {
            position: absolute;
            top: 10px;
            left: -30px; /* ドロップダウンの横に配置したい場所に調整 */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>乱数総当たりツール</h1>
    <a href="list.html" target=”_blank”>簡易乱数表はこちら</a><br>
    <span>1以上の乱数を総当たりします</span><br>
    <!--form action="#" method="post"-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <label for="seedStart">開始seed</label>
    <input type="text" id="seedStart" name="seedStart" value="0x32700">
    <label for="end">終了seed</label>
    <input type="text" id="seedEnd" name="seedEnd" value="0x327ff"><br>

    <label>検索範囲指定ショートカット</label><br>
    <select id="seedlist">
        <option></option>
        <option>700-7ff</option>
        <option>600-8ff</option>
    </select>

    <label for="end">1seed辺りの調査回数</label><br>
    <span>(制限する時は現在F+入力個数以上にする必要があります。)</span><br>
    <input type="number" id="end" name="end" value="1000"><br>
    <label for="maxCount">表示上限</label>
    <input type="number" id="maxCount" name="maxCount" value="1000"><br>
    <span>消費数指定、未入力で乱数を特定するには20個以上の入力が必要です</span><br>
    <label for="end">1つめの項目の消費数(任意)</label>
    <input type="number" id="nowCount" name="nowCount"><br>
    <label for="end">最後の項目の消費数(任意、優先)</label>
    <input type="number" id="nowCount1" name="nowCount1"><br>
    <label for="seed1">初期シード指定(指定したシード値以外除外,例:0x3272f)</label>
    <input type="text" id="seed1" name="seed1"><br>
    <button class="red-button" type="submit" onclick="onReset1()">リセット</button><br>
    <label for="end">この入力を共有</label>
    <input type="text" id="share" name="share" onclick="this.select()"><br>


    <button class="blue-button" type="submit" onclick="onRun()">開始</button>
    <br>

    <label>選択してください(飛ばし不可)</label>
    <div class="dropdown"></div>
    <button class="blue-button" type="submit" onclick="onRun()">開始</button>
    <table id="myTable">
        <tr>
            <th>seed</th>
            <th>開始[F]</th>
            <th>最終項目[F]</th>
            <th>現在地[F]</th>
            <th>リスト表示</th>
        </tr>
    </table>
    <span id="error"></span><br>
    <span id="info1"></span><br>
    <span id="info"></span><br>

    <button class="blue-button" type="submit" onclick="onRun()">開始</button>
    <!--/form-->
</div>
<br>
<br>
<div>
    <span>使い方</span><br>
    <ul style="list-style: disc; padding-left: 40px; color: black;">
        <li>シンボルに接触し、戦闘に入ります</li>
        <li>戦闘開始時に「魔物たちはまだこちらに気づいていない」または「魔物たちはおどろきとまどっている」と表示(「[魔物名]があらわれた」以外)された場合、全員「ぼうぎょ」して1ターン待ちます。</li>
        <li>このツールを開き、「しらべる」コマンドで、</li>
        <ul style="list-style: disc; padding-left: 40px; color: black;">
            <li>「[魔物名]はこちらのようすをうかがっている！」と表示された場合「ようす」</li>
            <li>「[魔物名]はこうげきにそなえている。」と表示された場合「こうげき」</li>
        </ul>
        <li>を「選択してください」付近のドロップダウンに入力します。</li>
        <li>ツールに18個～23個入力した時点で、「開始」ボタンを押して、検索結果を確認します(候補が1つになるまで入力を繰り返してください)</li>
        <li>「一致なし」と表示された場合、入力ミスまたはフィルタ機能を無効にしてみてください</li>
    </ul>
</div>
<script>
    const TYPE_SELECT_COUNT = 50;
    let URL = "";
    let hasUpdate = false;
    setInterval(function(){
        if (hasUpdate&&URL !== ""){
            hasUpdate =false;
            window.history.replaceState({}, '', URL);
        }
    },1000);
    for (let i = 0; i < TYPE_SELECT_COUNT; i++) {
        generateDropdown();
    }
    function onReset1(){
        window.location.href = `${window.location.origin}${window.location.pathname}`;
    }

    function seedlist1(){
        console.log();
        let element = document.getElementById('seedlist').value;
        let start = null;
        let end = null;
        if (element === "700-7ff"){
            start = "0x32700";
            end = "0x327ff";
        }
        if (element === "600-8ff"){
            start = "0x32600";
            end = "0x328ff";
        }
        if (start !== null&&end !== null){
            document.getElementById('seedStart').value = start;
            document.getElementById('seedEnd').value = end;
            saveInputValuesToURL();
        }
    }
    function saveInputValuesToURL() {
        let list = [];

        if (document.getElementById('seedStart').value !== "0x32700"){
            list.push(document.getElementById('seedStart'));
        }
        if (document.getElementById('seedEnd').value !== "0x327ff"){
            list.push(document.getElementById('seedEnd'));
        }
        if (document.getElementById('end').value !== "1000"){
            list.push(document.getElementById('end'));
        }
        if (document.getElementById('maxCount').value !== "1000"){
            list.push(document.getElementById('maxCount'));
        }
        if (document.getElementById('nowCount').value !== ""){
            list.push(document.getElementById('nowCount'));
        }
        if (document.getElementById('nowCount1').value !== ""){
            list.push(document.getElementById('nowCount1'));
        }
        if (document.getElementById('seed1').value !== ""){
            list.push(document.getElementById('seed1'));
        }

        let queryParams = new URLSearchParams("");

        list.forEach(inputElement => {
            if (inputElement.value !== "") {
                const inputId = inputElement.id;
                const inputValue = inputElement.value;
                queryParams.set(inputId, inputValue);
            }
        });

        let str = "";
        for (let i = 0; i <= TYPE_SELECT_COUNT; i++) {
            let select = document.getElementById("menu" + i).value;
            if (select === "") {
                break;
            }
            if (select === "ようす") {
                str += "0";
            } else {
                str += "1";
            }
        }
        if (str !== ""){
            queryParams.set("status", str);
        }


        // 現在のURLにクエリパラメータを設定
        let newURL;
        if (queryParams.toString() !== ""){
            newURL = `${window.location.origin}${window.location.pathname}?${queryParams.toString()}`;
        }else{
            newURL = `${window.location.origin}${window.location.pathname}`;
        }
        //window.history.replaceState({}, '', newURL);
        document.getElementById('share').value = newURL;
        URL = newURL;
        hasUpdate = true;
    }

    function loadInputValuesFromURL() {
        let list = [
            document.getElementById('seedStart'),
            document.getElementById('seedEnd'),
            document.getElementById('end'),
            document.getElementById('maxCount'),
            document.getElementById('nowCount'),
            document.getElementById('nowCount1'),
            document.getElementById('seed1')
        ];

        let queryParams = new URLSearchParams(window.location.search);

        list.forEach(inputElement => {
            const inputId = inputElement.id;
            const paramValue = queryParams.get(inputId);
            if (paramValue !== null) {
                inputElement.value = paramValue;
            }
        });

        const input = queryParams.get("status");
        if (input === null){
            return;
        }
        for (var i = 0; i < input.length; i++) {
            let status = "こうげき";
            if (input.charAt(i) === "0") {
                status = "ようす";
            }
            document.getElementById("menu" + i).value = status;
        }
    }

    // ページが読み込まれたら実行
    window.addEventListener('load', () => {
        loadInputValuesFromURL();
        saveInputValuesToURL();
        // 各 input 要素に変更リスナーを追加
        let list = [
            document.getElementById('seedStart'),
            document.getElementById('seedEnd'),
            document.getElementById('end'),
            document.getElementById('maxCount'),
            document.getElementById('nowCount'),
            document.getElementById('nowCount1'),
            document.getElementById('seed1')
        ];

        list.forEach(inputElement => {
            inputElement.addEventListener('input', saveInputValuesToURL);
        });
        document.getElementById('seedlist').addEventListener('input', seedlist1);

    });

    function onRun() {
        const seedStart = decodeHexValue(document.getElementById('seedStart').value);
        const seedEnd = decodeHexValue(document.getElementById('seedEnd').value);
        const end = parseInt(document.getElementById('end').value);
        const maxCount = parseInt(document.getElementById('maxCount').value);
        let inputElement = document.getElementById('nowCount');
        let nowCount = inputElement.value.trim() !== '' ? parseInt(inputElement.value) : null;
        let inputElement1 = document.getElementById('nowCount1');
        let nowCount1 = inputElement1.value.trim() !== '' ? parseInt(inputElement1.value) : null;
        if (nowCount !== null && nowCount1 !== null) {
            nowCount = null;
        }
        let inputElement2 = document.getElementById('seed1');
        let seed1 = inputElement2.value.trim() !== '' ? decodeHexValue(inputElement2.value) : null;
        if (seedEnd - seedStart < 0) {
            window.alert("開始seedと終了シードが不正です");
            return;
        }
        if (end < 0) {
            window.alert("終了seedドが不正です");
            return;
        }
        let need = [];
        for (let i = 0; i <= TYPE_SELECT_COUNT; i++) {
            let select = document.getElementById("menu" + i).value;
            if (select === "") {
                break;
            }
            need[i] = select;
        }
        // if (need.length === 0){
        //     window.alert("乱数が未入力です");
        //     return;
        // }
        document.getElementById('error').innerHTML = "";
        document.getElementById('info').innerHTML = "";
        document.getElementById('info1').innerHTML = "";

        let search = "";
        for (let m = 0; m <= need.length - 1; m++) {
            if (need[m] === "ようす") {
                search += "0";
            } else {
                search += "1";
            }

        }

        // テーブル要素を取得
        var table = document.getElementById("myTable");

        // テーブルの行の数を取得
        var rowCount = table.rows.length;

        // 最初の行（ラベル行）を除いてすべての行を削除
        for (var i = rowCount - 1; i > 0; i--) {
            table.deleteRow(i);
        }

        let found = 0;
        for (let initial = seedStart; initial <= seedEnd; initial++) {
            if (seed1 !== null&&initial !== seed1){
                continue;
            }
            let str = "";
            let now = BigInt(initial);//0x3275c

            for (let currentF = 1; currentF <= end; currentF++) {
                now = rand(now); //乱数を更新
                let percent = calculatePercent(rand(now)); //調べるは+1した乱数を参照するため
                let status = (((percent % BigInt(2)).toString(10)) === "0" ? "ようす" : "こうげき");
                if (status === "ようす") {
                    str += "0";
                } else {
                    str += "1";
                }
                if (str.endsWith(search)) {
                    let startF = currentF - need.length + 1;
                    if (nowCount1 !== null && currentF !== nowCount1) {
                        continue;
                    } else if (nowCount !== null && startF !== nowCount) {
                        continue;
                    }
                    ++found;
                    let data = ["0x" + initial.toString(16), startF, currentF, currentF + 1, '<a href="list.html?seed='+initial.toString(16)+'&start='+(currentF + 1)+'&end='+(startF+500)+'#table" target=”_blank”>'+initial.toString(16)+'</a>'];
                    var row = table.insertRow(-1); // テーブルの末尾に行を追加
                    for (var j = 0; j < 5; j++) {
                        var cell = row.insertCell(j);
                        cell.innerHTML = data[j];
                    }
                }
            }
            if (found > maxCount) {
                document.getElementById('error').innerHTML = "表示上限を超えた為停止しました。";
                break;
            }
        }
        if (seed1 !== null){
            document.getElementById('info1').innerHTML = "「初期シード = 0x"+seed1.toString(16)+"」でフィルターされています。";
        }
        if (nowCount !== null) {
            document.getElementById('info').innerHTML = "「1つめの項目の消費数 = "+nowCount+"」でフィルターされています。";
        }
        if (nowCount1 !== null) {
            document.getElementById('info').innerHTML = "「最後の項目の消費数 = "+nowCount1+"」でフィルターされています。<br>この項目が正しくない場合、このツールは間違った初期シードを表示します";
        }
        if (found === 0) {
            document.getElementById('error').innerHTML = "一致なし";
        }

        //}
        //console.log(j+" => 0x"+now.toString(16)+" => "+percent.toString(10)+", "+(((percent % BigInt(2)).toString(10)) === "0" ? "ようす" : "こうげき"));
    }
</script>
</body>
</html>
