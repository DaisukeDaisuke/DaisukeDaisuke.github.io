<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>dq9初期パーティーの名前職業決定ツール</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 10px;
            background: #f5f5f5;
            box-sizing: border-box;
        }

        .input-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        #input-message {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        #input-message:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76,175,80,0.3);
        }

        .calc-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .calc-btn:hover {
            background: #45a049;
        }

        .result-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .member-info {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: #fafafa;
            width: 100%;
            box-sizing: border-box;
        }

        .member-info h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }

        .member-info p {
            margin: 5px 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .appearance-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .image-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .image-btn:hover {
            background: #1976D2;
        }

        .image-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .download-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: none;
        }

        .download-btn:hover {
            background: #F57C00;
        }

        .image-container {
            margin-top: 10px;
            text-align: center;
        }

        .character-image {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        .error {
            color: #f44336;
            font-size: 14px;
        }

        .initial-cost {
            background: #E8F5E8;
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 8px;
            font-weight: bold;
            color: #2E7D32;
            font-size: 14px;
        }

        /* レスポンシブ対応 */
        @media (max-width: 480px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .calc-btn {
                margin-top: 8px;
            }

            .appearance-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .image-btn, .download-btn {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
<div class="input-container">
    <label for="input-message">初期シードを入力してください (16進数)</label>
    <form id="FormAge" action="#">
        <div class="input-group">
            <input type="text" id="input-message" placeholder="例: 1A2B3C4D">
            <input type="button" class="calc-btn" onclick="showMessage()" value="計算">
        </div>
    </form>
</div>

<div class="result-container" id="result-container" style="display: none;">
    <div class="member-info">
        <h3>1人目</h3>
        <p id="output-message1">1人目: </p>
        <p id="output-message10">1人目形容: </p>
        <div class="appearance-controls">
            <button class="image-btn" id="image-btn-1" onclick="fetchImage(1)">画像を取得</button>
        </div>
        <div class="image-container" id="image-container-1"></div>
    </div>

    <div class="member-info">
        <h3>2人目</h3>
        <p id="output-message2">2人目: </p>
        <p id="output-message20">2人目形容: </p>
        <div class="appearance-controls">
            <button class="image-btn" id="image-btn-2" onclick="fetchImage(2)">画像を取得</button>
        </div>
        <div class="image-container" id="image-container-2"></div>
    </div>

    <div class="member-info">
        <h3>3人目</h3>
        <p id="output-message3">3人目: </p>
        <p id="output-message30">3人目形容: </p>
        <div class="appearance-controls">
            <button class="image-btn" id="image-btn-3" onclick="fetchImage(3)">画像を取得</button>
        </div>
        <div class="image-container" id="image-container-3"></div>
    </div>

    <div class="initial-cost">
        <p id="output-message4">初期消費: </p>
    </div>
</div>

<script>
    // グローバルキャッシュ
    let imageCache = {};
    let currentSeed = null;
    let currentParty = null;

    // インプットでエンターを押したときに実行するようにするコード
    const input = document.querySelector("#FormAge input[type='text']");

    input.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // ページリロード防止
            showMessage();
        }
    });

    /**
     * 職業と性別のマスタデータ
     * @typedef {Object} CharacterData
     * @property {string} name - キャラクター名
     * @property {string} job - 職業
     * @property {string} gender - 性別
     */

    /**
     * 形容データ
     * @typedef {Object} AppearanceData
     * @property {number} skin_tone - はだのいろ
     * @property {number} eye_color - めのいろ
     * @property {number} hair_color - かみのいろ
     * @property {number} body_type - 身長
     * @property {number} face_style - かお
     * @property {number} hair_style - かみがた
     * @property {string} url - 形容表示URL
     * @property {string} description - 人間が読める形式
     */

    /**
     * 名前生成結果
     * @typedef {Object} NameGenerationResult
     * @property {number} refId - 参照ID
     * @property {number} initialCost - 初期消費
     * @property {Array.<number>} memberIds - メンバーID配列
     * @property {Array.<string>} memberNames - 実際の名前配列
     * @property {Array.<CharacterData>} members - 詳細メンバー情報（実名付き）
     * @property {Array.<AppearanceData>} appearances - 形容データ配列
     */

    /**
     * パーティパターン定義
     * @typedef {Object} PartyPattern
     * @property {Array.<number>} middleRange - 2マス目の範囲 [min, max)
     * @property {Array.<number>|null} endRange - 3マス目の範囲 [min, max) または null
     * @property {number} refId - 参照ID
     * @property {number} initialCost - 初期消費
     * @property {Array.<number>} party - パーティメンバーのID配列
     */

    /**
     * 1マス目範囲グループ
     * @typedef {Object} FirstRangeGroup
     * @property {Array.<number>} firstRange - 1マス目の範囲 [min, max)
     * @property {Array.<PartyPattern>} patterns - パターン配列
     */

    /**
     * ルックアップ結果
     * @typedef {Object} LookupResult
     * @property {number} refId - 参照ID
     * @property {number} initialCost - 初期消費
     * @property {Array.<number>} party - パーティメンバーのID配列
     * @property {Object} debug - デバッグ情報
     * @property {number} debug.first - 1マス目の値
     * @property {number} debug.middle - 2マス目の値
     * @property {number|null} debug.end - 3マス目の値
     */

// 名前マスタデータ（性別 × 職業 × 名前ID）
    const NAME_MASTER = {
        // 女性
        "女": {
            "戦士": ["カスティア", "キオリリ", "ズッチ", "レイ", "ミリア"],
            "武闘家": ["リナータ", "アマティ", "ノスワン", "ミント", "ビビアン"],
            "僧侶": ["モッチィ", "リョコ", "ニッキ", "アイヤイ", "マロン"],
            "魔法": ["イクミン", "ユッカ", "プリッチ", "リリ", "メルティー"]
        },
        // 男性
        "男": {
            "戦士": ["エーデル", "グスフィ", "バンチョ", "マスカット", "リック"],
            "武闘家": ["ブーショ", "アカメー", "マウヨリ", "サイトン", "マティカ"],
            "僧侶": ["カーツ", "カティブ", "アーミッツ", "プラース", "ガトゥーザ"],
            "魔法": ["ハイローズ", "トラジャ", "オマール", "ロッキャ", "レオノ"]
        }
    };

    /**
     * 職業と性別から実際の名前を取得する
     * @param {string} job - 職業名
     * @param {string} gender - 性別
     * @param {number} nameId - 名前ID (0-4)
     * @returns {string} 実際の名前
     */
    function getActualName(job, gender, nameId) {
        const genderNames = NAME_MASTER[gender];
        if (!genderNames) return `Unknown_Gender(${gender})`;

        const jobNames = genderNames[job];
        if (!jobNames) return `Unknown_Job(${job})`;

        const name = jobNames[nameId];
        return name || `Unknown_Name(${nameId})`;
    }

    const CHARACTER_MASTER = {
        0: { name: "戦士(男)", job: "戦士", gender: "男" },
        1: { name: "戦士(女)", job: "戦士", gender: "女" },
        2: { name: "武闘家(男)", job: "武闘家", gender: "男" },
        3: { name: "武闘家(女)", job: "武闘家", gender: "女" },
        4: { name: "僧侶(男)", job: "僧侶", gender: "男" },
        5: { name: "僧侶(女)", job: "僧侶", gender: "女" },
        6: { name: "魔法(男)", job: "魔法", gender: "男" },
        7: { name: "魔法(女)", job: "魔法", gender: "女" }
    };

    /**
     * チートシードのルックアップテーブル
     * @type {Array.<FirstRangeGroup>}
     */
    const CHEAT_SEED_TABLE = [
        // 1マス目: 0〜25
        {
            firstRange: [0, 25],
            patterns: [
                { middleRange: [0, 50], endRange: null, refId: 0, initialCost: 23, party: [0, 4, 7] },
                { middleRange: [50, 100], endRange: [0, 50], refId: 2, initialCost: 24, party: [0, 5, 6] },
                { middleRange: [50, 100], endRange: [50, 100], refId: 2, initialCost: 24, party: [0, 5, 7] }
            ]
        },
        // 1マス目: 25〜50
        {
            firstRange: [25, 50],
            patterns: [
                { middleRange: [0, 50], endRange: [0, 50], refId: 2, initialCost: 24, party: [1, 4, 6] },
                { middleRange: [0, 50], endRange: [50, 100], refId: 2, initialCost: 24, party: [1, 4, 7] },
                { middleRange: [50, 100], endRange: null, refId: 1, initialCost: 23, party: [1, 5, 6] }
            ]
        },
        // 1マス目: 50〜75
        {
            firstRange: [50, 75],
            patterns: [
                { middleRange: [0, 50], endRange: null, refId: 0, initialCost: 23, party: [2, 4, 7] },
                { middleRange: [50, 100], endRange: [0, 50], refId: 2, initialCost: 24, party: [2, 5, 6] },
                { middleRange: [50, 100], endRange: [50, 100], refId: 2, initialCost: 24, party: [2, 5, 7] }
            ]
        },
        // 1マス目: 75〜100
        {
            firstRange: [75, 100],
            patterns: [
                { middleRange: [0, 50], endRange: [0, 50], refId: 2, initialCost: 24, party: [3, 4, 6] },
                { middleRange: [0, 50], endRange: [50, 100], refId: 2, initialCost: 24, party: [3, 4, 7] },
                { middleRange: [50, 100], endRange: null, refId: 1, initialCost: 23, party: [3, 5, 6] }
            ]
        }
    ];

    /**
     * キャラクターIDから名前を取得する
     * @param {number} id - キャラクターID
     * @returns {string} キャラクター名
     */
    function getCharacterName(id) {
        const char = CHARACTER_MASTER[id];
        return char ? char.name : `Unknown(${id})`;
    }

    /**
     * キャラクターIDから職業を取得する
     * @param {number} id - キャラクターID
     * @returns {string} 職業名
     */
    function getCharacterJob(id) {
        const char = CHARACTER_MASTER[id];
        return char ? char.job : "Unknown";
    }

    /**
     * キャラクターIDから性別を取得する
     * @param {number} id - キャラクターID
     * @returns {string} 性別
     */
    function getCharacterGender(id) {
        const char = CHARACTER_MASTER[id];
        return char ? char.gender : "Unknown";
    }

    /**
     * パーティIDの配列から名前の配列に変換する
     * @param {Array.<number>} partyIds - パーティメンバーのID配列
     * @returns {Array.<string>} パーティメンバーの名前配列
     */
    function getPartyNames(partyIds) {
        return partyIds.map(id => getCharacterName(id));
    }

    /**
     * チートシードをルックアップする
     * @param {BigInt} f0 - 1マス目の値（既に25で割り済み）
     * @param {BigInt} f1 - 2マス目の値（既に50で割り済み）
     * @param {BigInt|null} f2 - 3マス目の値（既に50で割り済み）または null
     * @returns {LookupResult|null} ルックアップ結果。該当なしの場合は null
     */
    function lookupCheatSeed(f0, f1, f2) {
        // BigIntから通常の数値に変換
        const first = Number(f0);
        const middle = Number(f1);
        const end = f2 !== null ? Number(f2) : null;

        // 1マス目の範囲を特定
        for (const group of CHEAT_SEED_TABLE) {
            if (first >= group.firstRange[0] && first < group.firstRange[1]) {
                // 該当する1マス目の範囲内でパターンを検索
                for (const pattern of group.patterns) {
                    // 2マス目の条件をチェック
                    const middleMatch = middle >= pattern.middleRange[0] && middle < pattern.middleRange[1];

                    // 3マス目の条件をチェック
                    let endMatch = true;
                    if (pattern.endRange === null) {
                        endMatch = true; // 3マス目が不要
                    } else if (end !== null) {
                        endMatch = end >= pattern.endRange[0] && end < pattern.endRange[1];
                    } else {
                        endMatch = false; // 3マス目が必要だが提供されていない
                    }

                    if (middleMatch && endMatch) {
                        return {
                            refId: pattern.refId,
                            initialCost: pattern.initialCost,
                            party: pattern.party,
                            debug: { first, middle, end }
                        };
                    }
                }
            }
        }

        return null; // 該当するパターンが見つからない
    }

    /**
     * 形容URLを生成する
     * @param {string} gender - 性別
     * @param {number} skin_tone - はだのいろ
     * @param {number} hair_style - かみがた
     * @param {number} hair_color - かみのいろ
     * @param {number} face_style - かお（変換済み）
     * @param {number} eye_color - めのいろ
     * @returns {string} 形容表示URL
     */
    function generateAppearanceUrl(gender, skin_tone, hair_style, hair_color, face_style, eye_color) {
        const baseUrl = "https://www.woodus.com/den/games/dq9ds/characreate/index.php";

        const remapped_eyes_female = {
            1: 14, 2: 13, 3: 12, 4: 15, 5: 16, 6: 20, 7: 17, 8: 21, 9: 2, 10: 3,
        };
        const remapped_eyes_male = {
            1: 4, 2: 5, 3: 6, 4: 7, 5: 8, 6: 9, 7: 18, 8: 10, 9: 11, 10: 19,
        };


        const remapped_hairnum_male = {
            1: 11, 2: 12, 3: 13, 4: 19, 5: 14,
            6: 15, 7: 16, 8: 17, 9: 19, 10: 18,
        };

        const remapped_hairnum_female = {
            1: 1, 2: 2, 3: 3, 4: 4, 5: 5, // 1 = 0
            6: 6, 7: 7, 8: 8, 9: 9, 10: 10,
        };

        let keys = {
            headcolor: skin_tone,
            hairnum: hair_style,
            haircolor: hair_color,
            eyecolor: eye_color,
        };

        console.log(keys)

        if (gender === "男") {
            keys.hairnum = remapped_hairnum_male[hair_style];
            keys.eyesnum = remapped_eyes_male[face_style];
        } else {
            keys.hairnum = remapped_hairnum_female[hair_style];
            keys.eyesnum = remapped_eyes_female[face_style];
        }

        const params = new URLSearchParams(keys);
        return `${baseUrl}?${params.toString()}`;
    }

    /**
     * 形容の人間が読める説明文を生成する
     * @param {string} gender - 性別
     * @param {number} skin_tone - はだのいろ
     * @param {number} hair_style - かみがた
     * @param {number} hair_color - かみのいろ
     * @param {number} face_style - かお
     * @param {number} eye_color - めのいろ
     * @param {number} body_type - 身長
     * @returns {string} 人間が読める形容説明
     */
    function generateAppearanceDescription(gender, skin_tone, hair_style, hair_color, face_style, eye_color, body_type) {
        return `たいけい: ${body_type} かみがた: ${hair_style} かみのいろ: ${hair_color} かお: ${face_style} はだのいろ: ${skin_tone} めのいろ: ${eye_color}`;
    }

    /**
     * 1人分の形容データを生成する
     * @param {BigInt} seed - 現在のシード値
     * @param {string} gender - 性別
     * @param {number} initialCost - 初期消費
     * @param {number} f2 - 3マス目の値
     * @returns {Object} {seed: 更新されたシード, appearance: 形容データ}
     */
    function generateSingleAppearance(seed, gender, initialCost, f2) {
        const remapped_face_male = {
            0: 2, 1: 3, 2: 4, 3: 5, 4: 1,
            5: 6, 6: 7, 7: 8, 8: 9, 9: 10,
        };

        const remapped_face_female = {
            0: 2, 1: 1, 2: 3, 3: 4, 4: 5,
            5: 6, 6: 7, 7: 8, 8: 9, 9: 10,
        };

        var skin_tone = f2 + 1;

            // めのいろ
        seed = rand(seed);
        const f3 = getRand(Number(calculatePercent(seed)), 8);
        var eye_color = f3 + 1;

        // かみのいろ
        seed = rand(seed);
        const f4 = getRand(Number(calculatePercent(seed)), 10);
        var hair_color = f4 + 1;

        // 身長
        seed = rand(seed);
        const f5 = getRand(Number(calculatePercent(seed)), 5);
        var body_type = 5 - f5;

        // 名前（スキップ）
        seed = rand(seed);

        // かお
        seed = rand(seed);
        const f7 = getRand(Number(calculatePercent(seed)), 10);
        var face_style = f7;
        console.log(face_style);
        if(gender === "女"){
            face_style = remapped_face_female[face_style];
        }else{
            face_style = remapped_face_male[face_style];
        }

        // かみがた
        seed = rand(seed);
        const f8 = getRand(Number(calculatePercent(seed)), 10);
        var hair_style = 0;
        if(gender === "女") {
            hair_style = (f8 + 2) % 11;
        }else{
            hair_style = f8 + 1;
        }

        console.log(f2, f3, f4, f5, f7, f8);

        const url = generateAppearanceUrl(gender, skin_tone, hair_style, hair_color, face_style, eye_color);
        const description = generateAppearanceDescription(gender, skin_tone, hair_style, hair_color, face_style, eye_color, body_type);

        return {
            seed: seed,
            appearance: {
                skin_tone: skin_tone,
                eye_color: eye_color,
                hair_color: hair_color,
                body_type: body_type,
                face_style: face_style,
                hair_style: hair_style,
                url: url,
                description: description
            }
        };
    }

    /**
     * 完全なパーティ生成（職業・性別・実名・形容すべて含む）
     * @param {BigInt} initialSeed - 初期シード値
     * @param {BigInt} f0 - 1マス目の値（既に25で割り済み）
     * @param {BigInt} f1 - 2マス目の値（既に50で割り済み）
     * @param {BigInt} f2 - 3マス目の値（既に50で割り済み）または null
     * @returns {NameGenerationResult|null} 完全なパーティ情報。該当なしの場合は null
     */
    function generateFullParty(initialSeed, f0, f1, f2) {
        // パーティの基本構成を取得
        const partyResult = lookupCheatSeed(f0, f1, f2);
        if (!partyResult) return null;

        let seed = initialSeed;

        // 3人分の形容データを生成
        const appearances = [];

        for (let i = 0; i < 3; i++) {
            const characterId = partyResult.party[i];
            const baseChar = CHARACTER_MASTER[characterId];

            var f2_1 = 0;
            // はだのいろ
            if (partyResult.initialCost === 24 || i !== 0) {
                seed = rand(seed);
                f2_1 = getRand(Number(calculatePercent(seed)), 8);
            } else {
                //seed = rand(seed);
                f2_1 = getRand(Number(f2), 8);
            }

            const result = generateSingleAppearance(seed, baseChar.gender, partyResult.initialCost, f2_1);
            seed = result.seed;
            appearances.push(result.appearance);
        }

        // 名前ID用のシード位置を取得（6f, 13f, 20f目）
        let nameSeed = initialSeed;

        // 1人目の形容生成後のシード位置から名前IDを取得
        if (partyResult.initialCost === 24) {
            nameSeed = rand(nameSeed);
        }
        for (let i = 0; i < 4; i++) {
            nameSeed = rand(nameSeed);
        }

        const f6_2 = calculatePercent(nameSeed);

        // 13f目の値を取得
        for (let i = 0; i < 7; i++) {
            nameSeed = rand(nameSeed);
        }
        const f13 = calculatePercent(nameSeed);

        // 20f目の値を取得
        for (let i = 0; i < 7; i++) {
            nameSeed = rand(nameSeed);
        }
        const f20 = calculatePercent(nameSeed);

        // 名前IDを計算
        const nameIds = [
            Number(f6_2 / 20n),    // 1人目の名前ID (0-4)
            Number(f13 / 20n),     // 2人目の名前ID (0-4)
            Number(f20 / 20n)      // 3人目の名前ID (0-4)
        ];

        // 各メンバーの詳細情報と実名を生成
        const members = partyResult.party.map((characterId, index) => {
            const baseChar = CHARACTER_MASTER[characterId];
            const actualName = getActualName(baseChar.job, baseChar.gender, nameIds[index]);

            return {
                name: actualName,
                job: baseChar.job,
                gender: baseChar.gender,
                nameId: nameIds[index]
            };
        });

        return {
            refId: partyResult.refId,
            initialCost: partyResult.initialCost,
            memberIds: partyResult.party,
            memberNames: members.map(m => m.name),
            members: members,
            appearances: appearances,
            debug: {
                ...partyResult.debug,
                seeds: { f6: Number(f6_2), f13: Number(f13), f20: Number(f20) },
                nameIds: nameIds
            }
        };
    }

    function showMessage(){
        const seedStart = document.getElementById("input-message");
        var seed = seedStart.value;
        console.log(seed);

        if(seed === "" || Number.isNaN(seed)){
            alert("正しい整数を入力してください");
            return;
        }

        // 先頭が "0x" でなければ追加
        if(!seed.startsWith("0x") && !seed.startsWith("0X")){
            seed = "0x" + seed;
        }

        // シードが変わった場合はキャッシュをクリア
        if (currentSeed !== seed) {
            imageCache = {};
            currentSeed = seed;
            // 画像表示をクリア
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`image-container-${i}`).innerHTML = '';
                //document.getElementById(`download-btn-${i}`).style.display = 'none';
                document.getElementById(`image-btn-${i}`).disabled = false;
                document.getElementById(`image-btn-${i}`).textContent = '画像を取得';
            }
        }

        //0fを計算
        seed = rand(BigInt(seed));
        var f0 = calculatePercent(seed);

        //1fを計算
        seed = rand(seed);
        var f1 = calculatePercent(seed);

        //2fを計算
        seed = rand(seed);
        var f2 = calculatePercent(seed);

        //ルックアップテーブルから取得
        const party = generateFullParty(seed, f0, f1, f2);
        currentParty = party;

        // 結果を表示
        document.getElementById("output-message1").innerText = `1人目: ${party.members[0].name}/${party.members[0].job}(${party.members[0].gender})`;
        document.getElementById("output-message10").innerText = `1人目形容: ${party.appearances[0].description}`;
        document.getElementById("output-message2").innerText = `2人目: ${party.members[1].name}/${party.members[1].job}(${party.members[1].gender})`;
        document.getElementById("output-message20").innerText = `2人目形容: ${party.appearances[1].description}`;
        document.getElementById("output-message3").innerText = `3人目: ${party.members[2].name}/${party.members[2].job}(${party.members[2].gender})`;
        document.getElementById("output-message30").innerText = `3人目形容: ${party.appearances[2].description}`;
        document.getElementById("output-message4").innerText = `初期消費: ${party.initialCost} (${party.initialCost + 1})`;

        // 結果コンテナを表示
        document.getElementById("result-container").style.display = "block";

        // デバッグ用に形容URLをコンソールに出力
        console.log("1人目形容URL:", party.appearances[0].url);
        console.log("2人目形容URL:", party.appearances[1].url);
        console.log("3人目形容URL:", party.appearances[2].url);
    }

    /**
     * 画像を取得する
     * @param {number} memberIndex - メンバーインデックス (1-3)
     */
    async function fetchImage(memberIndex) {
        if (!currentParty) {
            alert('まずパーティを計算してください');
            return;
        }

        const cacheKey = `${currentSeed}_${memberIndex}`;

        // 既に取得済みの場合はスキップ
        if (imageCache[cacheKey]) {
            console.log(`メンバー${memberIndex}の画像は既に取得済みです`);
            return;
        }

        const button = document.getElementById(`image-btn-${memberIndex}`);
        const container = document.getElementById(`image-container-${memberIndex}`);
        //const downloadBtn = document.getElementById(`download-btn-${memberIndex}`);

        // ボタンを無効化してローディング表示
        button.disabled = true;
        button.textContent = '取得中...';
        container.innerHTML = '<div class="loading">画像を取得中...</div>';

        try {
            const appearance = currentParty.appearances[memberIndex - 1];
            const imageUrl = appearance.url;

            // 簡単に「外部URLを直接表示」で済むならこちら:
            const img = document.createElement('img');
            img.src = imageUrl; // プロキシ経由不要でブラウザが直接表示する
            img.alt = `${currentParty.members[memberIndex - 1].name}の形容`;
            img.className = 'character-image';

            img.onload = () => {
                container.innerHTML = '';
                container.appendChild(img);

                // キャッシュに保存（objectURL は不要）
                imageCache[cacheKey] = {
                    url: imageUrl,
                    memberName: currentParty.members[memberIndex - 1].name
                };

                // ダウンロードボタンを表示
                //downloadBtn.style.display = 'inline-block';
                button.textContent = '取得済み';

                console.log(`メンバー${memberIndex}の画像を取得しました`);
            };

            img.onerror = () => {
                throw new Error('画像の読み込みに失敗しました');
            };

        } catch (error) {
            console.error('画像取得エラー:', error);
            container.innerHTML = `<div class="error">画像の取得に失敗しました: ${error.message}</div>`;
            button.disabled = false;
            button.textContent = '再試行';
        }
    }


    /**
     * 画像をダウンロードする
     * @param {number} memberIndex - メンバーインデックス (1-3)
     */
    function downloadImage(memberIndex) {
        const cacheKey = `${currentSeed}_${memberIndex}`;
        const cachedData = imageCache[cacheKey];

        if (!cachedData) {
            alert('まず画像を取得してください');
            return;
        }

        // ダウンロードリンクを作成
        const link = document.createElement('a');
        link.href = cachedData.objectURL;
        link.download = `DQ9_${cachedData.memberName}_${currentSeed.replace('0x', '')}.png`;

        // ダウンロードを実行
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log(`${cachedData.memberName}の画像をダウンロードしました`);
    }

    /**
     * @param {BigInt} seed - input seed
     * @returns {BigInt}
     */
    function rand(seed) {
        seed = seed * BigInt("0x5d588b656c078965");
        seed = seed + BigInt("0x269ec3");
        seed = seed & BigInt("0xFFFFFFFFFFFFFFFF");
        return seed;
    }

    /**
     * @param {BigInt} input
     * @returns {BigInt}
     */
    function calculatePercent(input) {
        let output = input >> BigInt(32);
        output = output * BigInt(100);
        output = output / (BigInt(2) << BigInt(31));
        return output;
    }

    /**
     * @param {BigInt} input
     * @returns Number
     */
    function calculatePercentFloat(input) {
        let output = input >> BigInt(32);
        output = output * BigInt(100);
        let test = (BigInt(2) << BigInt(31));
        //output = output / test;
        output = division(output, test);
        return output;
    }

    /**
     * Thanks https://stackoverflow.com/questions/54409854/how-to-divide-two-native-javascript-bigints-and-get-a-decimal-result
     *
     * @param {BigInt} a
     * @param {BigInt} b
     * @returns Number
     */
    function division(a, b){
        return Number(a * 10000n / b) / 10000;
    }

    /**
     * @param {Number} nowPercent
     * @param {Number} max
     * @returns Number
     */
    function getRand(nowPercent, max){
        let randomValue = nowPercent / 100 * max;
        return Math.floor(randomValue);
    }

    /**
     * @param {BigInt} seed - input seed
     */
    function ARand(seed){
        let before = seed;
        seed = seed * BigInt("0x41C64E6D");
        seed = seed + BigInt("0x3039");
        seed = seed & BigInt("0xFFFFFFFF");

        let ret = BigInt("0x7FFF") & rightShift(seed,0x10);
        return [seed, ret];
    }

    /**
     * @param {BigInt} seed - input seed
     * @return BigInt
     */
    function getType(seed){
        let seed1 = rightShift(seed, 0x1f);
        seed = ((leftShift(seed, 0x1d) & BigInt("0xFFFFFFFF"))) - seed1 & BigInt("0xFFFFFFFF");
        if (seed < 0){
            seed = BigInt("0xFFFFFFFF") - seed;
        }
        seed1 = seed1 + ror(seed, BigInt(0x1d));
        seed1 = seed1 & BigInt(0xff);
        return seed1;
    }

    /**
     * @param {BigInt} input - input seed
     * @param {BigInt} ror
     * @return BigInt
     */
    function ror(input, ror){
        return (rightShift(input, ror) | (leftShift(input, (BigInt(32) - ror)))) & BigInt(0xFFFFFFFF);
    }

    function leftShift(num, shift) { // <<
        return num * (2n ** BigInt(shift));
    }

    function rightShift(num, shift) { // >>
        return num / (2n ** BigInt(shift));
    }

    /**
     * @param {BigInt} input - input seed
     * @return BigInt
     */
    function calculateATablePercentFloat(input) {
        let output = input * BigInt(100);
        //output = output / test;
        output = division(output, BigInt("0x7fff"));
        return output;
    }
</script>
</body>
</html>
